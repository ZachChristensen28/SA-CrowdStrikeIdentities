# DO NOT EDIT THIS FILE!
# Please make all changes to files in ../local.
# To make changes, copy the section/stanza you want to change from ./default
# into ../local and edit there.

[CrowdStrike Identities Lookup - Gen]
disabled = false
cron_schedule = 29 * * * *
description = populates kvstore lookup: crowdstrike_identities
dispatch.earliest_time = -61m@m
dispatch.latest_time = -1m@m
enableSched = 1
schedule_window = auto
search = `sa_crowdstrike_identities_index` sourcetype=crowdstrike:identities\
| dedup entityId \
| rename accounts{}.department as bunit, primaryDisplayName as first\
| eval\
    identity=lower(mvjoin(mvappend('accounts{}.samAccountName','accounts{}.upn'), "|")),\
    category=mvjoin(mvsort(lower(mvappend(\
    "ou: ".'accounts{}.ou',\
    "domain: ".'accounts{}.domain',\
    "roles: ".mvjoin('roles{}.type', ","),\
    "gen: sa-crowdstrike",\
    "risk_score: ".riskScore,\
    "risk_score_severity: ".riskScoreSeverity,\
    "watched: ".watched,\
    "pass_last_updated: ".'accounts{}.passwordAttributes.lastChange',\
    "title: ".case('accounts{}.title'!="null",'accounts{}.title'),\
    "account_control: ".'accounts{}.userAccountControl',\
    "archived: ".archived,\
    "risk_factors: ".mvjoin('riskFactors{}.type', ","),\
    "enabled: ".'accounts{}.enabled',\
    "splunk_last_updated: ".strftime(now(), "%x %T %Z")\
    ))), "|"),\
    email=mvindex('emailAddresses{}', 0),\
    priority=case(match(category, "admin"), "critical", true(), "medium"),\
    watchlist=case(watched=="true", "true", riskScore>=.80, "true"),\
    _last_seen=now(),\
    _key=entityId\
| table _key,_last_seen,identity,prefix,nick,first,last,suffix,email,phone,managedBy,priority,bunit,\category,watchlist,startDate,endDate,work_city,work_country,work_lat,work_long,cim_entity_zone\
| outputlookup key_field=_key crowdstrike_identities\
| stats count